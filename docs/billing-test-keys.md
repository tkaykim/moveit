# 구독/결제 테스트 (토스페이먼츠 테스트 키)

계약 없이 **API 개별 테스트 연동 키**로 카드 등록·구독 시작·자동결제 플로우를 검증할 수 있습니다.

## 사전 요구사항: billing DB 마이그레이션

구독/결제 관리 페이지가 **500 에러**를 내거나, 카드 등록 후 "아직 구독 정보가 없습니다"만 보인다면 **billing 테이블이 DB에 없을 가능성**이 큽니다.

- **필수**: Supabase에 billing 마이그레이션 적용  
  - 로컬: `npx supabase db push` 또는 Supabase 대시보드 SQL 에디터에서  
    `supabase/migrations/20250219000000_billing.sql` 파일 내용을 **전체 실행**  
  - 적용되는 테이블: `billing_plans`, `academy_subscriptions`, `subscription_payments`  
- 마이그레이션 적용 후에는 **토스 테스트 키만** 있으면 카드 등록·구독 조회가 동작합니다.  
- **토스 테스트키**: 문서용 키를 그대로 써도 되고, [토스페이먼츠 개발자센터](https://developers.tosspayments.com)에서 **나만의 테스트 키**를 발급받아 써도 됩니다. 둘 다 테스트 환경에서는 실제 출금 없이 동작합니다.

## 테스트 키 설정

`.env.local`에 다음 값을 넣습니다.

```env
# API 개별 테스트 연동 키 (토스페이먼츠 개발자센터 문서 제공)
NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_4vZnjEJeQVxJzDoab4d8PmOoBN0k
TOSS_SECRET_KEY=test_sk_XjExPeJWYVQR12P55agr49R5gvNL
```

- **클라이언트 키**: 브라우저에서 결제창/빌링 등록창 띄울 때 사용 (공개 가능).
- **시크릿 키**: 서버에서 빌링키 발급·자동결제 승인 시에만 사용. **절대 클라이언트/저장소에 올리지 말 것.**

설정 후 개발 서버를 한 번 재시작하세요.

## 카드 등록 모달에서 테스트하는 방법

1. **테스트 키 설정**  
   `.env.local`에 위의 `NEXT_PUBLIC_TOSS_CLIENT_KEY`, `TOSS_SECRET_KEY`(test_ 로 시작하는 키)가 설정되어 있는지 확인하고, 개발 서버를 재시작하세요.

2. **카드 등록 창**  
   - **구독/결제 관리** 탭에서 **카드 등록** 클릭  
   - 또는 대시보드 **구독 플랜 선택 및 결제** → **카드 등록 및 구독하기** 클릭  
   → 토스페이먼츠 카드 등록(빌링 인증) 창이 뜹니다.

3. **카드 정보 입력**  
   - **테스트용 국내 카드번호는 별도로 제공되지 않습니다.**  
   - 토스페이먼츠 공식 안내: **테스트 환경에서는 실제 카드 정보를 입력해도 실제 출금이 되지 않습니다.**  
   - 본인 명의 카드로 카드번호·유효기간·CVC·비밀번호 앞 2자리를 입력해 등록하면, 테스트 모드에서는 결제/청구가 되지 않으니 그대로 테스트하시면 됩니다.

4. **등록 후**  
   - 등록이 성공하면 **구독/결제 관리** 또는 **대시보드**로 돌아옵니다.  
   - **카드 등록 = 14일 무료 체험 시작**: 구독이 **체험 중(trial)**으로 생성되며, 체험 기간 중에는 별도 결제 없이 이용 가능합니다. 체험 종료일 이후 Cron에서 자동으로 첫 결제가 시도됩니다. 체험 중 **구독 시작**(즉시 결제)으로 플랜·주기 선택 후 결제할 수도 있습니다.

## 정상 절차 (카드 등록이 성공했을 때)

1. **구독/결제 관리**에서 **카드 등록** 클릭 → 토스 카드 입력 창으로 이동(리다이렉트).
2. 카드 정보 입력 후 인증 완료 → 토스가 우리 **콜백 URL**로 리다이렉트 (`/academy-admin/[학원ID]/billing/callback?authKey=...&customerKey=...`).
3. 콜백 페이지에서 **「카드 등록을 처리하고 있습니다…」** 표시 → 서버가 토스에 빌링키 발급 요청 → DB에 저장.
4. **「카드가 등록되었습니다. 14일 무료 체험이 시작되었습니다.»** 메시지가 약 1초 정도 보임 → 자동으로 **구독/결제 관리** 페이지로 이동(`?card=ok`).
5. 구독/결제 관리 페이지가 **구독·카드 정보를 다시 불러와** 등록한 카드(카드사·마스킹 번호)와 **체험 중** 구독(체험 종료일 포함)이 보임.

테스트 환경에서도 위와 동일한 절차이며, **실제 본인 카드를 사용**해야 인증이 통과합니다(테스트 키 사용 시 출금·청구 없음).

## 테스트 절차 요약

1. **학원 관리자**로 로그인한 뒤 해당 학원의 **구독/결제 관리** (`/academy-admin/[academyId]/billing`)로 이동.
2. **카드 등록** 클릭 → 토스 결제창에서 카드 정보 입력 (테스트 환경에서는 실제 카드 입력해도 출금 없음).
3. 등록이 완료되면 **14일 무료 체험**이 시작되고(**체험 중** 구독 생성), 체험 기간 후 자동 결제되거나 **구독 시작**에서 플랜·주기 선택 후 즉시 결제 가능.
4. (선택) Admin **구독 관리** (`/admin/billing`)에서 해당 학원 구독·통계 확인.

## 참고

- 테스트 키는 **실제 결제가 발생하지 않습니다.**
- 자동결제(빌링) 상용 사용은 토스페이먼츠와 계약 후 발급한 라이브 키로 전환해야 합니다.
- 출처: [자동결제(빌링) 연동 가이드 - API 키 준비하기](https://docs.tosspayments.com/guides/v2/billing)
