# 토스페이먼츠 API 키 정리 (공식 문서·에러 코드 기준)

## 1. 클라이언트 키 두 종류 — 용도가 다름

토스페이먼츠 공식 문서(document 222, SDK 초기화)와 에러 코드(document 204) 기준:

| 용도 | 사용할 클라이언트 키 | 잘못 쓰면 발생하는 에러 |
|------|----------------------|-------------------------|
| **결제위젯** (`widgets()`, `renderPaymentMethods`, `widgets.requestPayment`) | **결제위젯 연동 키** | `NOT_SUPPORTED_API_INDIVIDUAL_KEY` — "결제위젯 연동 키의 클라이언트 키로 SDK를 연동해주세요. **API 개별 연동 키는 지원하지 않습니다.**" |
| **결제창** (`payment().requestPayment`), **빌링** (`payment().requestBillingAuth`), **브랜드페이** | **API 개별 연동 키** | `NOT_SUPPORTED_WIDGET_KEY` — "**API 개별 연동 키**의 클라이언트 키로 SDK를 연동해주세요. 결제위젯 연동 키는 지원하지 않습니다." |

- **결제위젯을 쓰는 화면** → 반드시 **결제위젯 연동 키**로 `TossPayments(clientKey)` 초기화.
- **결제창만 쓰는 화면** / **빌링(카드·계좌 등록)** → **API 개별 연동 키**로 초기화.

같은 프로젝트에서 결제위젯과 결제창/빌링을 둘 다 쓰면, **클라이언트 키를 용도별로 구분**해 써야 합니다.

---

## 2. 클라이언트 키 ↔ 시크릿 키 매칭

공식 문서에서 반복해서 나오는 내용:

- "**클라이언트 키와 매칭된 시크릿 키**를 사용하고 있는지 확인하세요."
- "결제 요청에 사용한 **클라이언트 키**와 결제 승인에 사용한 **시크릿 키**가 **매칭된 키값**인지 확인하세요."
- "API 키는 토스페이먼츠에 로그인한 뒤 **개발자센터의 API 키 메뉴**에서 확인할 수 있어요."

즉, **클라이언트 키와 시크릿 키는 한 쌍**이어야 합니다.  
결제 요청 시 A 클라이언트 키를 썼으면, 결제 승인(및 빌링키 발급 등)에는 **A와 쌍인 시크릿 키**를 써야 합니다.

- **결제위젯**으로 결제한 경우: 문서(예: PayPal 연동)에 "**결제위젯 연동 키 > 시크릿 키** 를 사용해요"라고 되어 있음 → 결제 승인에는 **결제위젯 연동 키와 쌍인 시크릿 키** 사용.
- **API 개별 연동 키**로 결제창/빌링을 쓴 경우: **API 개별 연동 키와 쌍인 시크릿 키** 사용.

개발자센터에서 **결제위젯 연동 키**와 **API 개별 연동 키**가 각각 별도 시크릿 키를 가질 수 있으므로,  
두 종류를 다 쓰는 프로젝트는 **환경 변수도 용도별로 두 개** 두는 것이 안전합니다.

---

## 3. 이 프로젝트에서의 대응

### 현재 구조

- **NEXT_PUBLIC_TOSS_CLIENT_KEY**: 세션 예약 결제(현재 `payment.requestPayment`), 구독 모달, 카드 등록, 빌링 훅에서 사용 → 모두 **결제창/빌링** 용도이므로 **API 개별 연동 키**가 맞음.
- **TOSS_SECRET_KEY**: 서버 결제 승인, 빌링키 발급, 자동결제, 환불 등에 사용 → **API 개별 연동 키와 쌍인 시크릿 키**여야 함.

현재는 **결제위젯을 쓰지 않고** 결제창만 쓰므로, 위 설정이면 **결제위젯 연동 키 / API 개별 연동 키** 정책에 맞습니다.

### 결제위젯 도입 시 (계획된 수강권 결제 모달)

- **결제위젯**을 쓰는 코드에서는 **반드시 결제위젯 연동 키**로만 SDK를 초기화해야 합니다.  
  지금처럼 `NEXT_PUBLIC_TOSS_CLIENT_KEY`(API 개별 연동 키)만 쓰면, `widgets()` 호출 시 **NOT_SUPPORTED_API_INDIVIDUAL_KEY** 에러가 납니다.

**권장 환경 변수 정리:**

| 변수명 | 용도 | 사용 위치 |
|--------|------|-----------|
| `NEXT_PUBLIC_TOSS_WIDGET_CLIENT_KEY` | 결제위젯 연동 키 (클라이언트) | 수강권 결제 **위젯** 모달에서만 `TossPayments(clientKey).widgets(...)` |
| `NEXT_PUBLIC_TOSS_CLIENT_KEY` | API 개별 연동 키 (클라이언트) | 결제창(`payment()`), 빌링(`requestBillingAuth`) — 세션 예약 기존 결제창, 구독·카드 등록 |
| `TOSS_SECRET_KEY` | API 개별 연동 키와 쌍인 시크릿 키 | 결제창/빌링으로 결제·등록한 건에 대한 결제 승인, 빌링키 발급, 자동결제, 환불 등 |
| `TOSS_WIDGET_SECRET_KEY` (선택) | 결제위젯 연동 키와 쌍인 시크릿 키 | **결제위젯**으로 결제한 건에 대한 결제 승인 (`/api/tickets/payment-confirm` 등) |

- 개발자센터에서 **결제위젯 연동 키**와 **API 개별 연동 키**가 **같은 MID·같은 시크릿**을 쓰는 경우에는, 서버는 `TOSS_SECRET_KEY` 하나만 써도 될 수 있습니다.
- **결제위젯 연동 키** 전용 시크릿이 따로 있다면, 위젯으로 결제한 건은 `TOSS_WIDGET_SECRET_KEY`로 결제 승인하도록 분기하는 것이 안전합니다. (개발자센터 API 키 메뉴에서 키 종류별 시크릿 확인 필요.)

### 구현 시 체크리스트

1. **결제위젯** 사용하는 컴포넌트/훅  
   - `TossPayments(process.env.NEXT_PUBLIC_TOSS_WIDGET_CLIENT_KEY)` 사용.  
   - `NEXT_PUBLIC_TOSS_CLIENT_KEY`(API 개별 연동 키) 사용 금지.

2. **결제창 / 빌링** 사용하는 곳  
   - `TossPayments(process.env.NEXT_PUBLIC_TOSS_CLIENT_KEY)` 유지.  
   - `NEXT_PUBLIC_TOSS_WIDGET_CLIENT_KEY` 사용 금지.

3. **서버 결제 승인**  
   - 위젯으로 생성된 결제 → 결제위젯 연동 키와 쌍인 시크릿 키 사용.  
   - 결제창/빌링으로 생성된 결제 → 기존처럼 `TOSS_SECRET_KEY` 사용.  
   - 개발자센터에서 두 키가 같은 시크릿을 쓰면 `TOSS_SECRET_KEY` 하나로 통일 가능.

4. **TOSS_SECRET_KEY와 NEXT_PUBLIC_TOSS_CLIENT_KEY “다르면 안 되나?”**  
   - 값이 “같다”는 뜻이 아니라, **같은 쌍(같은 MID/키 세트)**이어야 한다는 뜻입니다.  
   - 클라이언트에는 **API 개별 연동 키**, 서버에는 그와 **매칭된 시크릿 키**를 넣으면 됩니다.  
   - 결제위젯용은 **결제위젯 연동 키 + 그에 매칭된 시크릿 키**를 사용하면 됩니다.

---

## 4. 참고 — 공식 문서 인용

- **SDK 초기화 (document 222)**  
  "사용하고 싶은 제품에 따라 **필요한 클라이언트 키 종류가 다른데요**. … **결제위젯을 연동한다면 결제위젯 연동 키** 를 사용하세요. **브랜드페이, 결제창, 자동결제(빌링)를 연동한다면 API 개별 연동 키** 를 사용하세요."

- **에러 코드 (document 204)**  
  - 결제위젯: `NOT_SUPPORTED_API_INDIVIDUAL_KEY` — "결제위젯 연동 키의 클라이언트 키로 SDK를 연동해주세요. API 개별 연동 키는 지원하지 않습니다."  
  - 결제창/브랜드페이: `NOT_SUPPORTED_WIDGET_KEY` — "API 개별 연동 키의 클라이언트 키로 SDK를 연동해주세요. 결제위젯 연동 키는 지원하지 않습니다."

- **결제 승인 등**  
  "클라이언트 키와 **매칭된 시크릿 키**를 사용하고 있는지 확인하세요."

이 정리대로 적용하면, "결제위젯 연동 키로 SDK 연동" / "API 개별 연동 키는 지원하지 않음" / "클라이언트·시크릿 키 매칭" 요구사항에 모두 대응됩니다.
