# 비회원 계좌이체 예약 및 회원가입 후 매핑

비회원(비로그인) 상태에서의 수강권 구매·예약 신청, 학원 관리자 목록 처리, 회원가입 후 /my 매핑에 대한 정리 및 구현 계획 문서입니다.

---

## 1. 현재 구조

### 1.1 DB·API

| 항목 | 내용 |
|------|------|
| **bank_transfer_orders** | `user_id` nullable. 비회원 주문은 `user_id = null`, `orderer_name` / `orderer_phone` / `orderer_email` 저장 |
| **bookings** | `user_id` nullable. 비회원 예약은 `user_id = null`, `guest_name`, `guest_phone` 저장. `guest_email` 컬럼 없음 |
| **GET /api/bookings** | `user_id = user.id` 조건만 사용 → 비회원 예약은 /my에 노출되지 않음 |
| **POST /api/tickets/bank-transfer-order** | 비회원 시 `ordererName`(주문자 이름), `ordererPhone` 또는 `ordererEmail`(하나 필수), `depositorName`(선택) 기대 |

### 1.2 학원 관리자

| 화면 | 비회원 처리 |
|------|-------------|
| **수동 입금확인** | `academy_id` 기준 조회 → 비회원 주문 포함. `orderer_name`, `orderer_phone`, `orderer_email`로 표시·검색 |
| **출석/신청 관리** | 클래스별 bookings 조회, `user_id` 조건 없음 → 비회원 예약 포함. `guest_name`, `guest_phone` 검색·표시 |
| **입금 확인** | 비회원 주문은 입금 확인 시 수강권 미발급. 주문·예약만 CONFIRMED. "주문자 연락처로 수강권 수령 방법 안내" 메시지 |

### 1.3 프론트 이슈

- 비회원일 때 **주문자 이름**과 **입금자명**을 구분해 API에 보내지 않음 (입금자명만 `ordererName`으로 전달).
- 계좌 안내 확인 후 완료 화면이 비회원/회원 구분 없이 "마이페이지로 이동"만 노출 → 비회원은 예약 현황 확인을 위해 회원가입/로그인 유도 필요.

---

## 2. 구현 계획

### 2.1 비회원 예약 신청 API 규격 맞추기

**대상**: `app/(main)/book/session/[sessionId]/page.tsx`

- 비회원 시 요청 body에 다음을 구분해 전달:
  - `ordererName`: 주문자 이름 (guestOrderer.name)
  - `ordererPhone`, `ordererEmail`: 비회원 폼 입력값
  - `depositorName`: 입금자명 (입금자명 모달 입력값)
- 회원은 기존처럼 `ordererName`(입금자명/프로필) 사용, 필요 시 `depositorName` 추가.

### 2.2 완료 후 비회원일 때 회원가입/로그인 유도

**대상**: 동일 `page.tsx`

- 상태: `bankTransferCompletedAsGuest` 추가. 계좌이체 신청 성공 시 비회원이면 `true` 설정.
- 완료 안내 모달:
  - 공통: "예약이 완료되었습니다. 학원에서 입금이 확인되면 예약이 확정됩니다."
  - 비회원일 때: "예약 현황을 확인하려면 회원가입 또는 로그인해 주세요." + **회원가입** / **로그인** 버튼 → `MyTab` 열기.
  - 회원일 때: 기존처럼 "마이페이지로 이동" → `/my`.

### 2.3 회원가입 후 /my 매핑

**목표**: 같은 연락처로 가입한 사용자가 /my에서 비회원 시절 예약을 볼 수 있게 함.

**권장 방식**: 로그인/회원가입 성공 직후(또는 /my 최초 진입 시) 1회 호출

- **API**: `POST /api/me/link-guest-bookings`
  - 조건: `bookings.user_id IS NULL AND bookings.guest_phone = user.phone`
  - 처리: 해당 행의 `user_id = user.id` 업데이트
  - (선택) `bank_transfer_orders`에서 `orderer_phone` / `orderer_email` 일치 시 `user_id` 업데이트
- **클라이언트**: 로그인/회원가입 성공 후 또는 /my 진입 시 1회만 호출 (중복 방지).

**참고**: `bookings`에는 `guest_email`이 없어 매핑은 **연락처(guest_phone ↔ user.phone)** 기준. 이메일 매핑을 원하면 `bookings`에 `guest_email` 추가 후 linking 조건 확장 가능.

### 2.4 학원 관리자 UI 보완 (선택)

- 수동 입금확인 목록에서 `user_id`가 null인 주문에 **"비회원"** 뱃지 표시 → 입금 확인 후 수강권 미발급인 경우를 구분하기 쉽게 함.

### 2.5 비회원 입금 확인 시 수강권

- 비회원 주문은 입금 확인 시 수강권(`user_tickets`)을 생성하지 않음.
- 회원가입 후 매핑해도 **예약만** /my에 노출되고, 수강권은 없음. 필요 시 "수강권은 학원에 문의" 등 안내 문구 노출 가능.

---

## 3. 수정·추가 파일 요약

| 구분 | 파일 | 변경 내용 |
|------|------|-----------|
| 프론트 | `app/(main)/book/session/[sessionId]/page.tsx` | ① 비회원 시 ordererName/depositorName 구분 전달 ② bankTransferCompletedAsGuest, 완료 모달 비회원 분기(회원가입/로그인 버튼) |
| API | `app/api/me/link-guest-bookings/route.ts` | 신규. `guest_phone = user.phone` 인 booking에 `user_id` 설정 |
| 클라이언트 | 로그인/회원가입 성공 또는 /my 진입 | link-guest-bookings 1회 호출 |
| 학원 admin (선택) | 수동 입금확인 뷰 또는 API | `user_id` null 주문에 "비회원" 표시 |

---

## 4. 흐름 요약

```
비회원 예약: [이름/연락처/이메일] → [입금자명] → 신청 → 계좌 안내 → 확인
  → 완료 안내 + "예약 현황 확인을 위해 회원가입/로그인" + [회원가입] [로그인]
  → 회원가입/로그인 후 link-guest-bookings 호출 → /my에서 해당 예약 노출

학원 관리자: 수동 입금확인·출석/신청 관리에 비회원 주문·예약 이미 포함. 입금 확인 시 비회원은 수강권 미발급.
```

---

## 5. 체크리스트

- [x] 프론트: 비회원 시 ordererName(주문자명) + depositorName(입금자명) 구분 전달
      → `submitBankTransferOrder(guestOrderer.name, phone, email, depositorName)` 으로 수정
- [x] 프론트: 완료 모달 비회원 분기(회원가입/로그인 버튼, MyTab 연동)
      → `bankTransferCompletedAsGuest` 상태 추가, 완료 모달에서 비회원이면 회원가입/로그인 버튼 표시
- [x] API: POST /api/me/link-guest-bookings 구현
      → `app/api/me/link-guest-bookings/route.ts` 신규 생성
- [x] 클라이언트: /my 진입 시 link-guest-bookings 1회 호출
      → `components/views/my-page-view.tsx`에 useEffect로 1회 호출 추가
- [x] (선택) 수동 입금확인 목록에 비회원 뱃지
      → 이미 구현됨 (`deposit-confirm-view.tsx`에 `회원`/`비회원` 뱃지 존재)
- [ ] (선택) bookings에 guest_email 추가 후 이메일 매핑 지원
