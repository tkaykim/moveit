# 토스페이먼츠 인앱 결제 UX — 최종 점검 (공식 문서·MCP 기준)

## 질문: 웹/앱 모두에서 "새 페이지·별도 브라우저·새 창 없이 그 화면에서 바로 결제"가 맞는지

### 결론 요약

| 구분 | 내용 | 토스 정책 준수 |
|------|------|----------------|
| **결제 시작 ~ 결제 진행** | 새 창/새 탭/외부 브라우저 없이 **같은 화면(모달 + 같은 창)**에서 결제 가능 | **준수** |
| **결제 완료 후** | 토스 Redirect 방식 때문에 **successUrl/failUrl로 1회 리다이렉트(같은 창 내 이동)** 발생 | **정책 필수 동작** |

- **“그 화면에서 바로 결제”**: 결제 **진행** 구간(수단 선택 ~ 인증 ~ 승인 요청)은 모두 **같은 창(같은 탭/WebView)**에서 이루어지며, 새 창·외부 브라우저로 나가지 않는다.
- **“페이지 이동 없이”**: 결제 **완료 후**에는 토스 API가 정한 Redirect 방식 때문에, **같은 창 안에서** success/fail 페이지로 한 번 이동한다. 이는 토스 정책을 위반하지 않으며, “새 창 열기”나 “다른 브라우저로 넘어가기”와는 다르다.

---

## 1. 토스페이먼츠 공식 문서(document 222, MCP) 기준 정리

### 1) 결제 수단 선택 UI — 같은 페이지에 렌더

- **결제위젯** `widgets.renderPaymentMethods({ selector })`  
  - “결제 UI를 **렌더링할 위치를 지정**합니다. `<div>` 와 같은 HTML 요소를 선택할 수 있는 **CSS 선택자**를 사용합니다.”
  - 즉, **지정한 DOM(예: 모달 안 `#payment-method-widget`)에** 결제 수단 UI가 렌더된다.
- **효과**: 결제 수단 선택은 **새 창/새 탭 없이**, 현재 페이지(우리 모달) **그 화면에서** 이뤄진다. → **“그 화면에서 바로 결제”에 부합.**

### 2) 결제창이 뜨는 위치 — 새 창이 아닌 “현재 브라우저/iframe”

- **windowTarget** (document 222):
  - **`self`**: “**현재 브라우저**를 결제창으로 이동시켜요. **모바일 환경에서 기본 값**입니다.”
  - **`iframe`**: “**iframe**에서 결제창이 열려요. **PC 환경에서 기본 값**입니다. **모바일 환경에서는 iframe을 사용할 수 없습니다.**”
- **효과**:
  - **모바일/앱**: 기본 `self` → 결제창은 **같은 WebView/같은 탭**에서 열리고, **새 창(팝업)이나 외부 브라우저로 이동하지 않음.**
  - **PC(웹)**: 기본 `iframe` → 결제창은 **같은 페이지의 iframe** 안에서 열림 → **새 창/별도 브라우저 아님.**

따라서 **“새 창을 열어서 이동”·“별도의 브라우저로 넘어감”은 발생하지 않도록** 토스 SDK가 설계되어 있으며, 현재 계획(결제위젯 + 모달 + Intent 처리)과 일치한다.

### 3) 결제 완료 후 — Redirect와 1회 페이지 이동

- **widgets.requestPayment()** (document 222):
  - “Redirect 방식을 선택하면 파라미터로 설정한 **successUrl 또는 failUrl 로** 결제 요청의 **결과를 확인**할 수 있어요.”
  - “**Promise 방식은 모바일 환경에서 사용할 수 없어요.**”
- **효과**:
  - 모바일/앱에서는 **Redirect 방식만** 사용 가능.
  - Redirect 방식에서는 **결제 성공/실패 시 반드시 successUrl/failUrl로 리다이렉트**된다. 즉, **결제 완료 후 “한 번의 페이지 이동”은 토스 API 정책상 필수**이며, 이를 생략하면 정책을 위반하거나 결제 결과를 공식 방식으로 받을 수 없다.
  - 이 리다이렉트는 **같은 창(같은 탭/WebView)**에서 우리 도메인(https, 같은 origin)의 success/fail 페이지로 이동하는 것이지, “새 창”이나 “다른 브라우저”를 여는 것이 아니다.

정리하면:

- **“페이지가 이동되는 것 없이”**를 “결제 **진행** 중에는 이동 없음”으로 이해하면 → **현재 계획과 토스 문서 모두와 일치.**
- **“결제 완료 후까지 단 한 번의 이동도 없어야 한다”**로 이해하면 → 토스 Redirect 정책과 **양립 불가**이며, 모바일에서는 Promise 미지원으로 그대로 두면 **정책 위반 또는 미지원 사용**에 해당할 수 있음.

본 프로젝트는 **“결제 진행은 같은 화면, 완료 후에는 토스가 정한 대로 success/fail로 1회 리다이렉트”**로 해석·구현하는 것이 맞고, 이는 **토스 API 정책 위반이 아니다.**

---

## 2. 웹 vs 앱 동작 정리

| 단계 | 웹 | 앱(Capacitor) |
|------|----|----------------|
| 결제 수단 선택 | 모달 내 `renderPaymentMethods(selector)` → **같은 페이지, 새 창 없음** | 동일 |
| 결제하기 클릭 후 결제창 | `windowTarget` 기본: PC=iframe, 모바일=self → **같은 탭/같은 뷰** | **self** → **같은 WebView** |
| 카드/ISP 앱 호출 | 브라우저가 intent 등 처리 (환경 의존) | **Intent 인터셉트** → 외부 브라우저 안 띄우고 해당 앱만 실행 |
| 결제 완료 후 | successUrl/failUrl로 **같은 탭** 리다이렉트 | successUrl/failUrl로 **같은 WebView** 리다이렉트 |

- **새 페이지로 이동**: 결제 **진행** 중에는 없음. **완료 후** success/fail로 1회 이동(같은 창).
- **별도 브라우저로 넘어감**: 웹·앱 모두 **없음** (앱은 Intent 처리로 보장).
- **새 창으로 이동**: **없음** (팝업 미사용, self/iframe만 사용).

---

## 3. 토스페이먼츠 API 정책 준수 체크

| 항목 | 요구 사항 (공식 문서·MCP) | 현재 계획 | 준수 |
|------|---------------------------|-----------|------|
| successUrl/failUrl | https, 오리진 포함, 결제창 연 페이지와 같은 origin | `window.location.origin` 기반 https만 사용 | 예 |
| 커스텀 스킴 | successUrl/failUrl에 사용 불가 | moveitapp 등 미사용 | 예 |
| 결제위젯 렌더 | DOM selector로 위치 지정 | 모달 내 div에 `renderPaymentMethods` | 예 |
| windowTarget | 모바일: self 기본, iframe 불가 / PC: iframe 가능 | 기본값 사용(모바일=self, PC=iframe) | 예 |
| Redirect 방식 | 모바일에서 Promise 미지원 → Redirect 사용 | successUrl/failUrl로 Redirect | 예 |
| appScheme | 페이북/ISP 앱 복귀용, successUrl과 별개 | 앱에서만 appScheme 전달 | 예 |

---

## 4. 최종 답변

- **웹이든 앱이든**,  
  - **새 창을 열지 않고**,  
  - **별도 브라우저로 넘어가지 않고**,  
  - **결제 진행 구간에서는 페이지를 바꾸지 않고**,  
  **그 화면(모달 + 같은 창/WebView)에서 바로 결제할 수 있도록** 구현된 것이 맞다.

- **결제 완료 후**에만, 토스 Redirect 정책에 따라 **같은 창 안에서** success/fail URL로 **한 번** 이동한다. 이는 **토스페이먼츠 API 정책을 위반하지 않으며**, 공식 문서와 tospayments MCP 기준을 따른 동작이다.

- 모든 계획은 **토스페이먼츠 공식 문서(document 222 등) 및 tospayments MCP** 내용에 맞춰 정리되어 있으며, successUrl/failUrl, windowTarget, Redirect/Promise, 결제위젯 렌더 방식 모두 **정책을 준수하는 범위**로 설계되어 있다.
